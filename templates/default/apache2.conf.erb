#
# Generated by Chef
#
# Based on the Ubuntu apache2.conf

ServerRoot "<%= @node[:apache][:dir] %>"

User <%= @node[:apache][:user] %>
Group <%= @node[:apache][:user] %>
AccessFileName .htaccess
DefaultType text/plain
HostnameLookups Off
ServerTokens Prod
ServerSignature On


<% if @node[:platform] == "debian" || @node[:platform] == "ubuntu" -%>
LockFile /var/lock/apache2/accept.lock
<% else %>
LockFile logs/accept.lock
<% end -%>

<% if @node[:platform] == "debian" || @node[:platform] == "ubuntu" -%>
PidFile /var/run/apache2.pid
<% else -%>
PidFile logs/httpd.pid
<% end -%>

TraceEnable Off
Timeout <%= @node[:apache][:timeout] %>
KeepAlive <%= @node[:apache][:keepalive] %>
MaxKeepAliveRequests <%= @node[:apache][:keepaliverequests] %>
KeepAliveTimeout <%= @node[:apache][:keepalivetimeout] %>

<IfModule mpm_prefork_module>
    StartServers          <%= @node[:apache][:prefork][:startservers] %>
    MinSpareServers       <%= @node[:apache][:prefork][:minspareservers] %>
    MaxSpareServers       <%= @node[:apache][:prefork][:maxspareservers] %>
    MaxClients            <%= @node[:apache][:prefork][:maxclients] %>
    MaxRequestsPerChild   <%= @node[:apache][:prefork][:maxrequestsperchild] %>
</IfModule>

<IfModule mpm_worker_module>
    ServerLimit           <%= @node[:apache][:worker][:serverlimit] %>
    StartServers          <%= @node[:apache][:worker][:startservers] %>
    MaxClients            <%= @node[:apache][:worker][:maxclients] %>
    MinSpareThreads       <%= @node[:apache][:worker][:minsparethreads] %>
    MaxSpareThreads       <%= @node[:apache][:worker][:maxsparethreads] %>
    ThreadsPerChild       <%= @node[:apache][:worker][:threadsperchild] %>
    MaxRequestsPerChild   <%= @node[:apache][:worker][:maxrequestsperchild] %>
</IfModule>


<Files ~ "^\.ht">
    Order allow,deny
    Deny from all
</Files>

ErrorLog <%= @node[:apache][:log_dir] %>/error.log 
LogLevel warn

Include <%= @node[:apache][:dir] %>/mods-enabled/*.load
Include <%= @node[:apache][:dir] %>/mods-enabled/*.conf
Include <%= @node[:apache][:dir] %>/ports.conf
Include <%= @node[:apache][:dir] %>/conf.d/*.conf

LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{Host}i\" %{X-Runtime}o %D" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

<IfModule mod_mime.c>
  AddType application/x-compress .Z
  AddType application/x-gzip .gz .tgz
  TypesConfig /etc/mime.types
</IfModule>

# Don't log webmux heartbeat requests or websitepulse checks.

SetEnvIf Host "^VIP \-.*$" no-log
SetEnvIf User-Agent "^websitepulse.*" no-log

# don't serve gzipped js to IE 6

<FilesMatch "\.js$">
  BrowserMatch "MSIE 6.0" no-gzip
</FilesMatch>

# Only include the mtime and size in the ETag by default
FileETag MTime Size

<Location />
 # Disable directory indexes globally.
 Options -Indexes

 # Workaround for apache ETag bugs, see http://scarff.id.au/blog/2009/apache-304-and-mod%5Fdeflate-revisited/
 RequestHeader  edit "If-None-Match" "^(.*)-gzip$" "$1"

 # the following may be needed if the header quoting format is fixed but appending -gzip is not
 # Header  edit "ETag" "^(.*[^g][^z][^i][^p])$" "$1-gzip"
</Location>

<IfModule mod_proxy.c>
  <Proxy *>
    Order deny,allow
    Allow from 127.0.0.1
  </Proxy>
</IfModule>

##

Include <%= @node[:apache][:dir] %>/sites-enabled/